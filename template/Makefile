# =============================================================================
# PSX Decompilation Project Makefile
# =============================================================================
# This Makefile provides the build infrastructure for a PSX decompilation
# project using splat and the GCC 2.6/2.7 era PSX toolchain.
#
# Based on conventions from sotn-decomp, open-ribbon, and other PSX decomps.
# =============================================================================

# -----------------------------------------------------------------------------
# Configuration - Adjust these for your project
# -----------------------------------------------------------------------------

# Project name (used for output files)
PROJECT := game

# Game version (us, eu, jp, etc.)
VERSION := us

# Target binary (the original PSX executable to match)
TARGET := disks/$(VERSION)/SLUS_000.00

# Splat configuration file
SPLAT_CONFIG := config/splat.$(VERSION).yaml

# Build output directory
BUILD_DIR := build/$(VERSION)

# ASM output directory (from splat)
ASM_DIR := asm/$(VERSION)

# Source directory
SRC_DIR := src

# -----------------------------------------------------------------------------
# Toolchain Configuration
# -----------------------------------------------------------------------------

# PSX compiler (PSY-Q GCC 2.6 based)
CC1_PSX := bin/cc1-psx-26

# MIPS cross-toolchain (from Nix environment)
CROSS := mipsel-linux-gnu-
AS := $(CROSS)as
LD := $(CROSS)ld
OBJCOPY := $(CROSS)objcopy
CPP := $(CROSS)cpp
CC := $(CROSS)gcc
STRIP := $(CROSS)strip

# maspsx - PSX assembler macro expander
MASPSX := python3 tools/maspsx/maspsx.py

# Python (from Nix environment)
PYTHON := python3

# splat binary splitting tool
SPLAT := $(PYTHON) -m splat split

# -----------------------------------------------------------------------------
# Compiler Flags
# -----------------------------------------------------------------------------

# C preprocessor flags
CPPFLAGS := -I include -I include/psxsdk -D_LANGUAGE_C -DVERSION_$(VERSION)

# PSX compiler flags (GCC 2.6 compatible)
# -O2: Optimization level 2
# -G0: No global pointer optimization (required for overlays)
# -fno-builtin: Don't use builtin functions
# -mno-abicalls: No PIC/position independent code
# -mcpu=3000: MIPS R3000 (PSX CPU)
CFLAGS := -O2 -G0 -fno-builtin -mno-abicalls -mcpu=3000

# Assembler flags
ASFLAGS := -march=r3000 -mtune=r3000 -no-pad-sections -G0

# Linker flags
LDFLAGS := -nostdlib

# -----------------------------------------------------------------------------
# File Discovery
# -----------------------------------------------------------------------------

# Find all C source files
C_SRCS := $(shell find $(SRC_DIR) -name '*.c' 2>/dev/null)

# Find all ASM source files (from splat extraction)
S_SRCS := $(shell find $(ASM_DIR) -name '*.s' 2>/dev/null)

# Object files
C_OBJS := $(C_SRCS:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.c.o)
S_OBJS := $(S_SRCS:$(ASM_DIR)/%.s=$(BUILD_DIR)/%.s.o)

# All object files
OBJS := $(C_OBJS) $(S_OBJS)

# Linker script (generated by splat)
LD_SCRIPT := $(BUILD_DIR)/$(PROJECT).ld

# -----------------------------------------------------------------------------
# Targets
# -----------------------------------------------------------------------------

.PHONY: all clean extract expected diff context check tools help

# Default target
all: $(BUILD_DIR)/$(PROJECT).bin
	@echo "Build complete!"

# Show help
help:
	@echo "PSX Decompilation Project"
	@echo "========================="
	@echo ""
	@echo "Targets:"
	@echo "  all       - Build the project (default)"
	@echo "  extract   - Extract/disassemble the original binary using splat"
	@echo "  expected  - Copy original binary to expected/ for comparison"
	@echo "  diff      - Run asm-differ to compare output"
	@echo "  check     - Verify build matches original (sha1sum)"
	@echo "  context   - Generate context for decomp.me"
	@echo "  clean     - Remove build artifacts"
	@echo "  tools     - Download required toolchain binaries"
	@echo ""
	@echo "Decompilation workflow:"
	@echo "  1. Place original binary in disks/$(VERSION)/"
	@echo "  2. Run 'make extract' to disassemble"
	@echo "  3. Run 'make' to build"
	@echo "  4. Run 'make check' to verify match"
	@echo ""

# -----------------------------------------------------------------------------
# Extraction (splat)
# -----------------------------------------------------------------------------

extract: $(SPLAT_CONFIG)
	@echo "Extracting binary using splat..."
	$(SPLAT) $(SPLAT_CONFIG)
	@echo "Extraction complete. ASM files in $(ASM_DIR)/"

# -----------------------------------------------------------------------------
# Compilation Rules
# -----------------------------------------------------------------------------

# Create build directories
$(BUILD_DIR)/:
	mkdir -p $@

# Compile C to object file using PSX compiler chain
# 1. Preprocess with GCC
# 2. Compile with PSY-Q cc1
# 3. Process with maspsx (PSX assembler macros)
# 4. Assemble to object
$(BUILD_DIR)/%.c.o: $(SRC_DIR)/%.c | $(BUILD_DIR)/
	@mkdir -p $(dir $@)
	@echo "CC $<"
	@$(CPP) $(CPPFLAGS) $< -o $(BUILD_DIR)/$*.i
	@$(CC1_PSX) $(CFLAGS) $(BUILD_DIR)/$*.i -o $(BUILD_DIR)/$*.s
	@$(MASPSX) --aspsx-version=2.21 $(BUILD_DIR)/$*.s -o $(BUILD_DIR)/$*.maspsx.s
	@$(AS) $(ASFLAGS) $(BUILD_DIR)/$*.maspsx.s -o $@

# Assemble ASM files (from splat extraction or handwritten)
$(BUILD_DIR)/%.s.o: $(ASM_DIR)/%.s | $(BUILD_DIR)/
	@mkdir -p $(dir $@)
	@echo "AS $<"
	@$(AS) $(ASFLAGS) $< -o $@

# -----------------------------------------------------------------------------
# Linking
# -----------------------------------------------------------------------------

# Link all objects into ELF
$(BUILD_DIR)/$(PROJECT).elf: $(OBJS) $(LD_SCRIPT)
	@echo "LD $@"
	@$(LD) $(LDFLAGS) -T $(LD_SCRIPT) -Map $(BUILD_DIR)/$(PROJECT).map -o $@ $(OBJS)

# Convert ELF to raw binary (PSX format)
$(BUILD_DIR)/$(PROJECT).bin: $(BUILD_DIR)/$(PROJECT).elf
	@echo "OBJCOPY $@"
	@$(OBJCOPY) -O binary $< $@

# -----------------------------------------------------------------------------
# Verification
# -----------------------------------------------------------------------------

# Create expected directory with original binary for comparison
expected: $(TARGET)
	@mkdir -p expected/$(VERSION)
	@cp $(TARGET) expected/$(VERSION)/
	@echo "Copied original to expected/$(VERSION)/"

# Check if build matches original
check: $(BUILD_DIR)/$(PROJECT).bin $(TARGET)
	@echo "Comparing build to original..."
	@sha1sum $(BUILD_DIR)/$(PROJECT).bin $(TARGET)
	@if cmp -s $(BUILD_DIR)/$(PROJECT).bin $(TARGET); then \
		echo "✓ BUILD MATCHES ORIGINAL"; \
	else \
		echo "✗ BUILD DOES NOT MATCH"; \
		exit 1; \
	fi

# -----------------------------------------------------------------------------
# Diff Tools
# -----------------------------------------------------------------------------

# Run asm-differ on a function
# Usage: make diff FUNC=FunctionName
diff:
ifndef FUNC
	@echo "Usage: make diff FUNC=FunctionName"
	@exit 1
endif
	$(PYTHON) tools/asm-differ/diff.py -mwo $(FUNC)

# Generate context for decomp.me
# Usage: make context FILE=src/file.c
context:
ifndef FILE
	@echo "Usage: make context FILE=src/file.c"
	@exit 1
endif
	$(PYTHON) tools/m2c/m2ctx.py $(FILE)

# -----------------------------------------------------------------------------
# Tools
# -----------------------------------------------------------------------------

# Download toolchain binaries
tools:
	./tools/download-toolchain.sh

# -----------------------------------------------------------------------------
# Cleanup
# -----------------------------------------------------------------------------

clean:
	rm -rf $(BUILD_DIR)
	rm -rf asm
	rm -rf assets

# Clean only build artifacts, keep extracted files
clean-build:
	rm -rf $(BUILD_DIR)

# -----------------------------------------------------------------------------
# Progress Tracking
# -----------------------------------------------------------------------------

# Calculate decompilation progress
progress:
	@$(PYTHON) tools/progress.py $(BUILD_DIR)/$(PROJECT).map $(TARGET)
